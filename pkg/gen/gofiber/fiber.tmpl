{{ define "middleware" }}{{ range .Middleware | formatMiddleware }}{{ . }}, {{ end }}{{ end }}

{{ define "path" }}"{{ .Path | pathToString }}"{{ end }}

{{ define "custom_req_param" }}body.{{ .Name }} = {{ .FunctionName }}("{{ .Serialization }}"){{ end }}
{{ define "custom_resp_param" }}{{ .FunctionName }}("{{ .Serialization }}", res.{{ .Name}}){{ end }}

{{ define "endpoint" }}{{ .AppIdent }}.{{ .Method | httpMethodToFnIdent }}(
		{{ template "path" . }},
		{{ template "middleware" . }}
		func (c *fiber.Ctx) error {
			body := &{{ .ImportIdent }}.{{ .Body.Name }}{}

			{{ if not .IsGet }}
			if err := c.BodyParser(body); err != nil {
				return c.Status(fiber.StatusBadRequest).JSON(struct{Err string}{Err: "Bad request"})
			}
			{{ end }}

			{{ range .Body | toRequestParams }}{{ template "custom_req_param" . }}
			{{ end }}

			err := v.Struct(body)
			if err != nil {
				return c.Status(fiber.StatusBadRequest).JSON(struct{Err string}{Err: "Validation failed"})
			}

			res, err := {{ .RecieverIdent }}.{{ .Handler.Name }}(
				c.UserContext(),
				body,
			)
			if err != nil {
				return c.Status(fiber.StatusInternalServerError).JSON(struct{ Err string }{Err: "InternalServerError"})
			}

			{{ range .Response | toRespParams }}{{ template "custom_resp_param" . }}
			{{ end }}

			return c.JSON(res)
		},
	){{ end }}


{{ define "reciever" }}{{ .Ident }} {{ .Pointer | isPointer }}{{ .Import | importIdent }}.{{ .Name }}{{ end }}

{{ define "setup" }}
// Code generated by apispec. DO NOT EDIT.

package apispec

import (
	{{ range .SetupImports }}"{{.}}"
	{{ end }}

	{{ range .Imports}}
	{{.Ident}} "{{.Import}}"{{ end }}
)

func RegisterHandlers(
	app *fiber.App,
	v *validate.Validate,
	{{ range .Recievers }}{{ template "reciever" . }},
	{{ end }}
) {
	{{ range .Endpoints }}{{ template "endpoint" . }}
	{{ end }}
}
{{ end }}
